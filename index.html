<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>天使幸福智慧名片 V333</title>

<link rel="manifest" href="./manifest.json?v=333">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">

<style>
body{font-family:'Noto Sans TC',sans-serif;margin:0;background:#f5f6fa;display:flex;flex-direction:column;align-items:center;}
.card{background:white;width:92%;max-width:380px;border-radius:40px;overflow:hidden;box-shadow:0 30px 60px rgba(0,0,0,.15);margin:20px 0}
.banner{height:140px;background:linear-gradient(135deg,#ee5253,#d63031)}
.info-scroll{padding:20px}
.name{font-size:24px;font-weight:900}
.social-bar{display:flex;gap:12px;margin-top:10px}
.social-link{width:42px;height:42px;border-radius:12px;background:#fff;display:none;align-items:center;justify-content:center;font-size:18px;color:#d63031;box-shadow:0 4px 10px rgba(0,0,0,.1)}
.actions{padding:15px;border-top:1px solid #eee;display:grid;gap:10px}
.act-btn{text-decoration:none;background:#f1f2f6;padding:12px;border-radius:12px;text-align:center;font-weight:900;color:#2d3436}
.btn-main{background:#06C755!important;color:white!important}
</style>
</head>

<body>

<div class="card">
  <div class="banner"></div>

  <div class="info-scroll">
    <h1 id="u-name" class="name">讀取中...</h1>

    <div class="social-bar">
      <a id="lk1" class="social-link" target="_blank" rel="noopener"></a>
      <a id="lk2" class="social-link" target="_blank" rel="noopener"></a>
      <a id="lk3" class="social-link" target="_blank" rel="noopener"></a>
    </div>
  </div>

  <div class="actions">
    <a id="btn-oa" class="act-btn btn-main" target="_blank" rel="noopener">LINE 官方帳號</a>
    <a id="btn-mail" class="act-btn">寄送郵箱</a>
    <a id="btn-phone" class="act-btn">一鍵撥號</a>
  </div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const urlId = urlParams.get('id');
let allRows = [];

/* ---------- 工具判斷 ---------- */

const isLineDomain = (v) =>
  v.includes('line.me') || v.includes('lin.ee');

const isMapLink = (v) => {
  const s = (v || '').toLowerCase();
  return (
    s.includes('google.com/maps') ||
    s.includes('maps.google') ||
    s.includes('maps.app.goo.gl') ||
    s.includes('share.google') ||
    s.includes('maps.apple.com')
  );
};

// ✅ 把「地圖網址」包成「導航網址」
// - Apple Maps：直接用原網址（系統會處理導航）
// - Google Maps：改成 /dir/?api=1&destination=... 直接導航
const buildNavigationLink = (url) => {
  const s = (url || '').toLowerCase();
  if (s.includes('maps.apple.com')) return url;

  // Google / share.google / maps.app.goo.gl… 都用 destination 包起來
  if (isMapLink(url)) {
    return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(url)}`;
  }
  return url;
};

const isAllowedWebLink = (val) => {
  if (!val || !val.includes('http')) return false;
  const v = val.toLowerCase();

  // ✅ LINE：放聯繫區，不進影音/網頁 icon 區
  if (isLineDomain(v)) return false;

  // ✅ Drive：不要出現在 icon 區
  if (v.includes('drive.google.com')) return false;

  return true;
};

const linkIconHtml = (val) => {
  const v = (val || '').toLowerCase();

  if (isMapLink(v)) return '<i class="fa-solid fa-map-location-dot"></i>';

  if (v.includes('youtube') || v.includes('youtu.be'))
    return '<i class="fa-solid fa-play"></i>';

  // ✅ 抖音/ TikTok
  if (v.includes('tiktok') || v.includes('douyin'))
    return '<i class="fa-brands fa-tiktok"></i>';

  return '<i class="fa-solid fa-link"></i>';
};

/* ---------- 讀資料 ---------- */

async function loadSheetData() {
  const csvUrl =
    "https://docs.google.com/spreadsheets/d/16c21SGmuUVpKVnUrCvWt88OWZdepI76hawWW3DvNJMY/export?format=csv&gid=1350316682&t=" +
    Date.now();

  const res = await fetch(csvUrl, { cache: "no-store" });
  const text = await res.text();

  const rows = text.split(/\r?\n(?=(?:[^"]*"[^"]*")*[^"]*$)/);
  allRows = rows.map(r =>
    r
      .split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)
      .map(c => c.replace(/^"|"$/g, "").trim())
  );
}

function renderById(keyword) {
  if (!allRows[0]) return;

  const h = allRows[0];
  const d = allRows.find((r, i) => i !== 0 && (r[0] == keyword || r[1] == keyword));
  if (!d) return;

  const getVal = (key) => {
    const idx = h.findIndex(head => (head || "").includes(key));
    return (idx !== -1 && d[idx]) ? d[idx] : "";
  };

  // 基本資料
  document.getElementById("u-name").innerText = getVal("姓名") || "未填姓名";

  // 影音/網頁 icon 區（最多3個）
  let lkCount = 1;
  for (let i = 1; i <= 3; i++) document.getElementById("lk" + i).style.display = "none";

  h.forEach((head, idx) => {
    const val = d[idx];
    if (isAllowedWebLink(val) && lkCount <= 3) {
      const el = document.getElementById("lk" + lkCount);

      // ✅ 地圖→導航網址
      if (isMapLink(val)) el.href = buildNavigationLink(val);
      else el.href = val;

      el.innerHTML = linkIconHtml(val);
      el.style.display = "flex";
      lkCount++;
    }
  });

  // 聯繫區：LINE OA / Email / Phone
  const lineOA = getVal("LINE 官方") || getVal("官方帳號");
  const btnOA = document.getElementById("btn-oa");
  if (lineOA && lineOA.includes("http")) {
    btnOA.href = lineOA;
    btnOA.style.display = "block";
  } else {
    btnOA.style.display = "none";
  }

  const email = getVal("Email") || getVal("郵箱") || getVal("一鍵聯繫 Email");
  const btnMail = document.getElementById("btn-mail");
  if (email) {
    btnMail.href = "mailto:" + email;
    btnMail.style.display = "block";
  } else {
    btnMail.style.display = "none";
  }

  const phone = getVal("電話") || getVal("一鍵聯繫電話");
  const btnPhone = document.getElementById("btn-phone");
  if (phone) {
    btnPhone.href = "tel:" + phone.replace(/\s+/g, "");
    btnPhone.style.display = "block";
  } else {
    btnPhone.style.display = "none";
  }
}

async function init() {
  await loadSheetData();

  // ✅ 有 id：用該筆
  // ✅ 無 id：門面固定第一筆（第二列 allRows[1]）
  if (urlId) renderById(urlId);
  else if (allRows[1]) renderById(allRows[1][0]);
}

init();
</script>

</body>
</html>