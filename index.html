<script>
    // 這裡使用您剛才提供的發佈版 ID
    const PUB_ID = '2PACX-1vQ0afkWyngYyTexUeNJn50CHrKmZ6cl0CYBcfGSQ56SA1XcpMLi8dJwjkuAB3YY7LXaGtWM0IOR75zB';
    const params = new URLSearchParams(window.location.search);
    const rowId = params.get('id');
    const theme = params.get('theme') || 'warm-pink';

    if (rowId) {
        document.getElementById('preview-bar').style.display = 'none';
        document.getElementById('generator-box').style.display = 'none';
        document.getElementById('form-btn').style.display = 'none';
        document.body.className = `theme-${theme}`;
    }

    function setTheme(t) { document.body.className = `theme-${t}`; }

    function generateAndCopy() {
        const id = document.getElementById('input-id').value;
        const col = document.body.className.replace('theme-', '');
        const baseUrl = window.location.href.split('?')[0];
        const finalUrl = `${baseUrl}?id=${id}&theme=${col}`;
        navigator.clipboard.writeText(finalUrl);
        alert("✨ 交付連結已複製！");
    }

    async function init() {
        // 如果沒有帶 id 參數，預設抓取第 2 行
        const fetchId = rowId || document.getElementById('input-id').value || 2;
        
        // 這是讀取「發佈到網路」資料的專用 API 格式
        const url = `https://docs.google.com/spreadsheets/d/e/${PUB_ID}/pub?gid=681093399&single=true&output=csv`;
        
        try {
            const res = await fetch(url);
            const data = await res.text();
            
            // 將 CSV 格式轉為陣列
            const rows = data.split('\n').map(row => row.split(','));
            const targetRow = rows[fetchId - 1]; // 因為 CSV 第一行是標題，所以 fetchId 剛好對應行號

            if(targetRow) {
                // 根據您的欄位順序填入 (0:時間, 1:姓名, 2:職稱, 3:格言...)
                document.getElementById('user-name').innerText = targetRow[1] || '姓名';
                document.getElementById('user-title').innerText = targetRow[2] || '職稱';
                document.getElementById('user-slogan').innerText = targetRow[3] || '';
                
                let qaHtml = '';
                if(targetRow[8]) qaHtml += `<div class="qa-item"><span class="qa-q">Q: ${targetRow[8]}</span><p class="qa-a">${targetRow[9] || ''}</p></div>`;
                if(targetRow[10]) qaHtml += `<div class="qa-item"><span class="qa-q">Q: ${targetRow[10]}</span><p class="qa-a">${targetRow[11] || ''}</p></div>`;
                document.getElementById('qa-area').innerHTML = qaHtml;
                
                // 處理照片 (針對 Google Drive 連結轉為直連)
                const photoLink = targetRow[12];
                const photoId = photoLink ? photoLink.match(/[-\w]{25,}/) : null;
                document.getElementById('user-photo').src = photoId ? `https://drive.google.com/uc?export=view&id=${photoId[0]}` : 'https://via.placeholder.com/130';
            }
        } catch (e) {
            console.error("讀取失敗", e);
            document.getElementById('user-name').innerText = "資料同步異常";
        }
    }
    init();
</script>
