<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å¤©ä½¿å¹¸ç¦æ™ºæ…§åç‰‡ V347</title>

  <link rel="manifest" href="./manifest.json?v=347" />
  <meta name="theme-color" content="#ee5253" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet" />

  <style>
    :root{ --p:#ee5253; --s:#d63031; --bg:#f5f6fa; --line:#06C755; }

    .warm-pink{ --p:#ee5253; --s:#d63031; }
    .aurora-blue{ --p:#00a8ff; --s:#0097e6; }
    .vivid-orange{ --p:#f0932b; --s:#eb4d4b; }
    .royal-purple{ --p:#6c5ce7; --s:#4834d4; }
    .teal-green{ --p:#20bf6b; --s:#0b8d51; }

    body{
      font-family:'Noto Sans TC',sans-serif;
      margin:0;
      background:var(--bg);
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
    }

    /* ===== Admin panel (only main) ===== */
    #admin-panel{
      width:100%;
      background:rgba(255,255,255,0.92);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      text-align:center;
      padding:14px 0 10px;
      border-bottom:1px solid rgba(0,0,0,0.08);
      z-index:2000;
      flex-shrink:0;
    }
    .picker-group{ display:flex; justify-content:center; gap:12px; margin-bottom:8px; align-items:center; }
    .dot{
      width:30px;height:30px;border-radius:50%;
      cursor:pointer;border:3px solid white;
      box-shadow:0 8px 16px rgba(0,0,0,0.12);
    }
    .btn-style{
      padding:6px 12px;border-radius:18px;border:1px solid rgba(0,0,0,0.18);
      font-size:11px;cursor:pointer;background:#fff;font-weight:900;
    }
    .btn-style.active{ background:#2f3640!important; color:white!important; border-color:#2f3640!important; }

    .hint-bounce{
      font-size:12px;font-weight:900;color:#2d3436;opacity:0.9;letter-spacing:0.5px;
      display:inline-flex;align-items:center;gap:6px;user-select:none;
      animation: hintFloat 1.2s ease-in-out infinite;
    }
    .hint-bounce i{ color:var(--p); }
    @keyframes hintFloat{ 0%,100%{ transform: translateY(0);} 50%{ transform: translateY(-3px);} }

    /* ===== Card ===== */
    .card{
      width:92%;
      max-width:380px;
      height:680px;
      border-radius:44px;
      overflow:hidden;
      position:relative;
      margin:18px 0 12px;
      display:flex;
      flex-direction:column;
      background:rgba(255,255,255,0.92);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow:
        0 40px 90px rgba(0,0,0,0.16),
        0 12px 24px rgba(0,0,0,0.08);
      border:1px solid rgba(0,0,0,0.06);
    }

    .banner{
      height:160px;
      background:linear-gradient(135deg,var(--p),var(--s));
      flex-shrink:0;
      position:relative;
    }
    .arch-overlay{
      position:absolute;width:100%;height:90px;background:rgba(255,255,255,0.96);
      bottom:-1px;border-radius:90px 90px 0 0;
    }
    .style-flat .arch-overlay{ border-radius:0; height:34px; }
    .style-spot .arch-overlay{ border-radius:50% 50% 0 0; transform:scaleX(1.4); height:100px; }

    .avatar-wrap{
      width:128px;height:128px;background:rgba(255,255,255,0.98);
      border-radius:50%;
      padding:6px;
      box-shadow:0 22px 40px rgba(0,0,0,0.18);
      position:absolute;top:36px;left:50%;transform:translateX(-50%);
      z-index:100;
      border:1px solid rgba(0,0,0,0.06);
    }
    .avatar{ width:100%;height:100%;border-radius:50%;object-fit:cover; }

    .info-scroll{
      flex:1;
      overflow-y:auto;
      padding:45px 18px 0;
      text-align:center;
      scrollbar-width:none;
    }
    .info-scroll::-webkit-scrollbar{ display:none; }

    .name{ font-size:26px; font-weight:900; color:#2d3436; margin:4px 0; }
    .unit{ font-size:14px; color:var(--s); font-weight:800; margin-bottom:6px; }
    .motto{ font-size:13px;color:#2d3436;opacity:0.88;font-weight:800;margin:0 0 8px;line-height:1.5; display:none; }

    .brand-logo-below{
      width:50px;height:50px;border-radius:16px;
      background:rgba(255,255,255,0.96);
      display:none; align-items:center; justify-content:center;
      overflow:hidden;
      box-shadow:0 14px 22px rgba(0,0,0,0.10);
      border:1px solid rgba(0,0,0,0.06);
      margin:8px auto 8px;
    }
    .brand-logo-below img{ width:100%;height:100%;object-fit:cover; }

    .social-bar{ display:flex; justify-content:center; align-items:center; gap:12px; margin:8px 0 12px; min-height:46px; }
    .social-link{
      width:44px;height:44px;border-radius:16px;background:rgba(255,255,255,0.95);
      display:none; align-items:center; justify-content:center;
      text-decoration:none;font-size:19px;color:var(--p);
      box-shadow:0 14px 22px rgba(0,0,0,0.10);
      border:1px solid rgba(0,0,0,0.06);
      transition: transform .08s ease;
    }
    .social-link:active{ transform: scale(0.96); }

    .content-box{
      text-align:left;
      background:rgba(255,255,255,0.92);
      padding:16px;
      border-radius:22px;
      margin-bottom:12px;
      box-shadow:0 14px 28px rgba(0,0,0,0.06);
      border:1px solid rgba(0,0,0,0.05);
    }
    .label{ color:#9aa0a6;font-weight:900;font-size:11px;margin-bottom:8px;display:block; }

    /* ===== Share box (æˆå“ / é–€é¢å…±ç”¨ï¼Œä½†æˆå“è¤‡è£½ç•¶å‰ç¶²å€) ===== */
    #share-box{
      text-align:center;
      cursor:pointer;
      padding:10px 12px;
      border-radius:18px;
      background:rgba(6,199,85,0.08);
      border:1px solid rgba(6,199,85,0.35);
      box-shadow:0 10px 20px rgba(0,0,0,0.05);
      margin-bottom:12px;
      user-select:none;
    }
    #share-label{
      display:block;
      font-size:11px;
      font-weight:900;
      color:#1f7a46;
      margin-bottom:4px;
      opacity:0.95;
    }
    #share-main{
      font-weight:900;
      font-size:13px;
      color:#2d3436;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }

    /* ===== Actions / Contact Area (æ›´çŸ® + å‹•æ…‹å¹³è¡¡) ===== */
    .actions{
      background:linear-gradient(180deg, rgba(255,255,255,0.65), rgba(255,255,255,1));
      padding:6px 10px 8px;
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:6px;
      flex-shrink:0;
      border-top:1px solid rgba(0,0,0,0.08);
    }
    .actions.one-col{ grid-template-columns:1fr; }
    .actions.three{ grid-template-columns:repeat(3,1fr); }
    .actions.three .btn-main{ grid-column: span 3; }
    .actions.one-col .btn-main{ grid-column: span 1; }

    .act-btn{
      text-decoration:none;
      background:rgba(255,255,255,0.96);
      padding:6px 8px;
      border-radius:16px;
      color:#2d3436;
      font-size:12px;
      font-weight:900;
      text-align:left;
      border:2px solid var(--line); /* âœ…æ¡†å›ºå®šç¶ è‰² */
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 10px 18px rgba(0,0,0,0.05);
      min-height:38px;
    }
    .act-btn:active{ transform: scale(0.99); }

    .btn-main{
      background:linear-gradient(135deg, #06C755, #06b150)!important;
      color:white!important;
      border:none!important;
      box-shadow: 0 14px 22px rgba(6,199,85,0.22);
      min-height:42px;
      grid-column:span 2;
    }

    .btn-ico{
      width:26px;height:26px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      flex:0 0 auto;
      background:rgba(0,0,0,0.03);
      border:1px solid rgba(0,0,0,0.06);
    }
    .btn-main .btn-ico{
      background:rgba(255,255,255,0.20);
      border:1px solid rgba(255,255,255,0.28);
    }

    /* icon é¡è‰²ä¸é»‘ï¼Œä¸»è‰²åŒæ­¥ï¼ˆä½†æ¡†å›ºå®šç¶ ï¼‰ */
    .btn-ico i{ font-size:14px; color:var(--p); }
    .btn-main .btn-ico i{ color:#fff; }

    .btn-txt{ display:flex; flex-direction:column; line-height:1.08; gap:1px; }
    .btn-title{ font-size:12.5px; font-weight:900; }
    .btn-subtitle{ font-size:10px; opacity:.78; font-weight:800; }

    /* ===== Install modal ===== */
    #install-modal{
      display:none;
      position:fixed;
      top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.85);
      z-index:10000;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .modal-content{
      background:rgba(255,255,255,0.98);
      width:100%;
      max-width:330px;
      border-radius:28px;
      padding:18px;
      position:relative;
      box-shadow:0 30px 60px rgba(0,0,0,0.30);
    }
    .close-modal{ position:absolute; top:12px; right:16px; font-size:22px; color:#999; cursor:pointer; }

    .modal-title{
      margin:0 0 10px;
      font-weight:900;
      text-align:center;
      color:var(--p);
      font-size:16px;
      letter-spacing:0.5px;
    }

    .modal-actions{
      display:flex;
      gap:8px;
      margin-bottom:10px;
    }
    .mini-btn{
      flex:1;
      border:none;
      border-radius:14px;
      padding:9px 10px;           /* âœ…ç¸®å°è®ŠçŸ® */
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      box-shadow:0 12px 18px rgba(0,0,0,0.08);
    }
    .mini-btn.copy{
      background:#ffffff;
      border:1.5px solid rgba(0,0,0,0.12);
      color:#2d3436;
    }
    .mini-btn.install{
      background:linear-gradient(135deg, #06C755, #06b150);
      color:#fff;
    }
    .mini-btn.install[disabled]{
      opacity:0.45;
      cursor:not-allowed;
    }

    .modal-tab{ display:flex; gap:8px; margin:10px 0 10px; }
    .tab-btn{
      flex:1;
      padding:8px;
      border-radius:12px;
      border:1px solid rgba(0,0,0,0.16);
      background:#f8f9fa;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
    }
    .tab-btn.active{ background:var(--p); color:white; border-color:var(--p); }

    .tab-pane{
      display:none;
      text-align:left;
      font-size:13px;
      line-height:1.8;
      color:#444;
      background:#f8f9fa;
      border:1px solid rgba(0,0,0,0.10);
      padding:10px 12px;
      border-radius:14px;
    }
    .tab-pane.active{ display:block; }

    /* ===== Wechat modal ===== */
    #wechat-mask{
      display:none;
      position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.9);
      z-index:11000;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      color:white;
      padding:18px;
    }
    .wechat-card{
      background:rgba(255,255,255,0.98);
      color:#333;
      padding:20px;
      border-radius:26px;
      width:100%;
      max-width:320px;
      text-align:center;
      box-shadow:0 28px 60px rgba(0,0,0,0.35);
    }
    .wechat-id{
      font-size:18px;
      font-weight:900;
      background:#f0f0f0;
      padding:10px;
      border-radius:14px;
      margin:12px 0;
      word-break:break-all;
    }
    .wechat-copy{
      background:#07C160;
      color:white;
      border:none;
      padding:10px 12px;          /* âœ…ç¸®å°è®ŠçŸ® */
      border-radius:14px;
      font-weight:900;
      width:100%;
      cursor:pointer;
    }

    /* ===== Work drawer (éš±å½¢å¾Œå°) ===== */
    #work-drawer{
      width:100%;
      max-width:420px;
      background:#2d3436;
      color:white;
      max-height:0;
      overflow:hidden;
      transition:0.5s;
      position:fixed;
      bottom:0;
      z-index:12000;
      border-radius:34px 34px 0 0;
      box-shadow:0 -20px 40px rgba(0,0,0,0.35);
    }

    .drawer-inner{ padding:18px; text-align:center; }
    .drawer-inner input{
      width:92%;
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.18);
      outline:none;
      font-weight:800;
      font-size:13px;
    }
    .drawer-btn{
      width:92%;
      padding:12px;              /* âœ…ç¸®å°è®ŠçŸ® */
      margin-top:8px;
      border-radius:14px;
      border:none;
      font-weight:900;
      cursor:pointer;
      font-size:13px;
    }
    .drawer-btn.preview{ background:#ee5253; color:white; }
    .drawer-btn.copy{ background:#2ecc71; color:white; }

    .footer{
      font-size:11px;
      color:#9aa0a6;
      padding:10px 0 18px;
      cursor:pointer;
      text-align:center;
      user-select:none;
    }

    /* main vs delivery */
    .mode-delivery #admin-panel,
    .mode-delivery #gate-footer{
      display:none !important;
    }

    /* small helper */
    .hidden{ display:none !important; }
  </style>
</head>

<body class="warm-pink style-arch">

  <!-- Admin panel (main only) -->
  <div id="admin-panel">
    <div class="picker-group">
      <div class="dot" onclick="setTheme('warm-pink')" style="background:#ee5253"></div>
      <div class="dot" onclick="setTheme('aurora-blue')" style="background:#00a8ff"></div>
      <div class="dot" onclick="setTheme('vivid-orange')" style="background:#f0932b"></div>
      <div class="dot" onclick="setTheme('royal-purple')" style="background:#6c5ce7"></div>
      <div class="dot" onclick="setTheme('teal-green')" style="background:#20bf6b"></div>
    </div>

    <div class="picker-group" style="margin-top:2px;">
      <span class="hint-bounce"><i class="fa-solid fa-hand-pointer"></i> é»é¸é¡è‰²ç‰ˆå‹åƒè€ƒ</span>
    </div>

    <div class="picker-group">
      <button class="btn-style active" onclick="setStyle('arch', this)">å„ªé›…æ‹±å‹</button>
      <button class="btn-style" onclick="setStyle('flat', this)">ç°¡æ½”å¹³ç›´</button>
      <button class="btn-style" onclick="setStyle('spot', this)">æ™¨æ›¦èšå…‰</button>
    </div>
  </div>

  <div id="card-container" class="card">
    <div class="banner"><div class="arch-overlay"></div></div>

    <div class="avatar-wrap">
      <img id="u-img" class="avatar" alt="avatar" />
    </div>

    <div class="info-scroll">
      <h1 id="u-name" class="name">è®€å–ä¸­...</h1>
      <div id="u-unit" class="unit">è®€å–ä¸­...</div>
      <div id="u-motto" class="motto"></div>

      <div id="brand-logo" class="brand-logo-below"><img id="u-logo" alt="logo" /></div>

      <div class="social-bar" id="social-bar">
        <a href="#" id="lk1" class="social-link" target="_blank" rel="noopener"></a>
        <a href="#" id="lk2" class="social-link" target="_blank" rel="noopener"></a>
        <a href="#" id="lk3" class="social-link" target="_blank" rel="noopener"></a>
      </div>

      <!-- share box -->
      <div id="share-box" onclick="handleShare()">
        <span id="share-label">è¤‡è£½ç¶²å€</span>
        <div id="share-main"><i class="fa-solid fa-share-nodes"></i> åˆ†äº«é€™å¼µåç‰‡çµ¦æœ‹å‹</div>
      </div>

      <!-- main only: advantage / order -->
      <div id="advantage-box" class="content-box">
        <span class="label" style="color:var(--p);">ğŸ† ç‚ºä»€éº¼æ‚¨éœ€è¦æ™ºæ…§åç‰‡ï¼Ÿ</span>
        <div style="font-size:14px;color:#2d3436;margin-bottom:8px;font-weight:800;">ä¸€éµåˆ†äº«ï¼šè¤‡è£½ç¶²å€ï¼Œå¿«é€Ÿå‚³çµ¦ä»»ä½•äºº</div>
        <div style="font-size:14px;color:#2d3436;margin-bottom:8px;font-weight:800;">å½±éŸ³æ•´åˆï¼šYouTubeã€æŠ–éŸ³ç­‰ä¸€é é›†ä¸­å±•ç¤º</div>
        <div style="font-size:14px;color:#2d3436;font-weight:800;">å…§å®¹æ›´æ–°ï¼šå¾Œå°æ›´æ–°ï¼ŒåŒæ­¥æ›´æ–°</div>
      </div>

      <div id="order-box" class="content-box" style="background:rgba(255,249,249,0.92);border:1px dashed rgba(238,82,83,0.7);">
        <span class="label" style="color:var(--p)">ğŸ“ ç¬¬äºŒæ­¥ï¼šé ç´„è£½ä½œæ‚¨çš„æ™ºæ…§åç‰‡</span>
        <a href="https://forms.gle/dkeHW9tfEYiGx39U9" target="_blank" rel="noopener" style="color:#2d3436;text-decoration:none;font-weight:900;font-size:14px;">
          ç«‹å³å¡«å¯«é ç´„è¡¨å–® â†’
        </a>
      </div>

      <div class="content-box">
        <span class="label">æœå‹™é …ç›®</span>
        <div id="u-service" style="font-size:14.5px;color:#2d3436;line-height:1.6;white-space:pre-wrap;font-weight:700;">è®€å–ä¸­...</div>
      </div>

      <div id="install-entry" class="content-box hidden" style="text-align:center;">
        <span class="label" style="color:var(--p);">ğŸ“² å®‰è£åç‰‡åˆ°æ‰‹æ©Ÿæ¡Œé¢</span>
        <button class="mini-btn copy" style="width:100%;max-width:260px;" onclick="openInstallModal()">é–‹å•Ÿå®‰è£æ•™å­¸ï¼ä¸€éµè¤‡è£½ç¶²å€</button>
      </div>
    </div>

    <!-- Contact area -->
    <div id="actions-area" class="actions">
      <a href="https://lin.ee/2ac9Roe" id="btn-oa" class="act-btn btn-main" target="_blank" rel="noopener">
        <span class="btn-ico"><i class="fa-brands fa-line"></i></span>
        <span class="btn-txt">
          <span class="btn-title">LINE å®˜æ–¹å¸³è™Ÿ</span>
          <span class="btn-subtitle">é ç´„è¨‚è£½ / æ´½è©¢</span>
        </span>
      </a>

      <a href="javascript:void(0)" id="btn-wechat" class="act-btn" onclick="showWechatText()">
        <span class="btn-ico"><i class="fa-brands fa-weixin"></i></span>
        <span class="btn-txt">
          <span class="btn-title">å¾®ä¿¡</span>
          <span class="btn-subtitle">é»æ“Šé¡¯ç¤º ID</span>
        </span>
      </a>

      <a href="mailto:" id="btn-mail" class="act-btn">
        <span class="btn-ico"><i class="fa-solid fa-envelope"></i></span>
        <span class="btn-txt">
          <span class="btn-title">éƒµç®±</span>
          <span class="btn-subtitle">ä¸€éµå¯„ä¿¡</span>
        </span>
      </a>

      <a href="tel:" id="btn-phone" class="act-btn">
        <span class="btn-ico"><i class="fa-solid fa-phone"></i></span>
        <span class="btn-txt">
          <span class="btn-title">é›»è©±</span>
          <span class="btn-subtitle">ä¸€éµæ’¥è™Ÿ</span>
        </span>
      </a>

      <a href="#" id="btn-linep" class="act-btn hidden" target="_blank" rel="noopener">
        <span class="btn-ico"><i class="fa-brands fa-line"></i></span>
        <span class="btn-txt">
          <span class="btn-title">LINE åŠ å¥½å‹</span>
          <span class="btn-subtitle">ç§è¨Šè¯ç¹«</span>
        </span>
      </a>
    </div>
  </div>

  <!-- install modal -->
  <div id="install-modal" onclick="closeInstallModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <span class="close-modal" onclick="closeInstallModal(event)">&times;</span>
      <h3 class="modal-title">å®‰è£åç‰‡åˆ°æ¡Œé¢</h3>

      <div class="modal-actions">
        <button class="mini-btn copy" onclick="copyCurrentUrl()">ğŸ”— ä¸€éµè¤‡è£½åç‰‡ç¶²å€</button>
        <button class="mini-btn install" id="install-now-btn" onclick="doInstall()">ğŸ“² ä¸€éµå®‰è£</button>
      </div>

      <div class="modal-tab">
        <button class="tab-btn active" onclick="switchTab('apple')">ğŸ iPhone</button>
        <button class="tab-btn" onclick="switchTab('android')">ğŸ¤– Android</button>
      </div>
      <div id="apple-pane" class="tab-pane active">
        1) ç”¨ Safari æ‰“é–‹åç‰‡ç¶²å€<br>
        2) é»ä¸‹æ–¹ã€Œåˆ†äº«ã€â¬†ï¸<br>
        3) é¸ã€ŒåŠ å…¥ä¸»ç•«é¢ã€<br>
        4) ä»¥å¾Œæ¡Œé¢ç›´æ¥é»é–‹ä½¿ç”¨
      </div>
      <div id="android-pane" class="tab-pane">
        1) ç”¨ Chrome æ‰“é–‹åç‰‡ç¶²å€<br>
        2) é»å³ä¸Šè§’ã€Œâ‹®ã€<br>
        3) é¸ã€Œå®‰è£æ‡‰ç”¨ç¨‹å¼ / åŠ åˆ°ä¸»ç•«é¢ã€<br>
        4) ä»¥å¾Œæ¡Œé¢ç›´æ¥é»é–‹ä½¿ç”¨
      </div>
    </div>
  </div>

  <!-- wechat -->
  <div id="wechat-mask" onclick="this.style.display='none'">
    <div class="wechat-card" onclick="event.stopPropagation()">
      <i class="fa-brands fa-weixin" style="font-size:44px;color:#07C160;margin-bottom:10px;"></i>
      <h3 style="margin:6px 0 6px;">å¾®ä¿¡è¯ç¹« ID</h3>
      <div id="wechat-id-text" class="wechat-id">æœªæä¾›</div>
      <button class="wechat-copy" onclick="copyWechat()">é»æ“Šè¤‡è£½ ID</button>
    </div>
  </div>

  <!-- work drawer -->
  <div id="work-drawer">
    <div class="drawer-inner">
      <input type="text" id="work-id" placeholder="è¼¸å…¥åºè™Ÿæˆ–å§“å" />
      <button class="drawer-btn preview" onclick="doPreviewInPlace()">é è¦½æˆå“ï¼ˆä¸è·³å‡ºï¼‰</button>
      <button class="drawer-btn copy" onclick="doCopy()">è¤‡è£½äº¤è²¨ç¶²å€ï¼ˆå¸¶é¡è‰²/ç‰ˆå‹ï¼‰</button>
    </div>
  </div>

  <div id="gate-footer" class="footer" onclick="handleGate()">Â© 2026 å¹¸ç¦æ™ºæ…§åç‰‡ V347</div>

  <div class="footer" style="padding-top:0;">
    <span style="opacity:.75;font-weight:900;">Â© 2026 å¹¸ç¦æ™ºæ…§åç‰‡ï½œåƒ…ä¾›æˆæ¬Šä½¿ç”¨ï½œç¦æ­¢æœªæˆæ¬Šè¤‡è£½èˆ‡è½‰å”®</span>
  </div>

<script>
  const VERSION = 347;

  // ===== SW =====
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js?v=' + VERSION).catch(() => {});
    });
  }

  // ===== URL / Mode =====
  const urlParams = new URLSearchParams(window.location.search);
  const urlId = urlParams.get('id');

  const LS_THEME = 'angel_card_theme';
  const LS_STYLE = 'angel_card_style';

  let allRows = [];
  let clicks = 0;

  let curTheme = urlParams.get('theme') || localStorage.getItem(LS_THEME) || 'warm-pink';
  let curStyle = urlParams.get('style') || localStorage.getItem(LS_STYLE) || 'arch';

  let uiMain = !urlId; // main page if no id

  // ===== Install prompt =====
  let deferredPrompt = null;

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;

    // âœ…å¦‚æœæ˜¯æˆå“é ï¼šè‡ªå‹•æé†’ï¼ˆåªæé†’ä¸€æ¬¡ï¼‰
    if(!uiMain){
      // è®“ UI è‡ªå·±å‡ºç¾å®‰è£å…¥å£ï¼ˆæ›´è‡ªç„¶ï¼‰
      document.getElementById('install-entry').classList.remove('hidden');

      // ä¹Ÿå¯ç›´æ¥å½ˆä¸€æ¬¡ï¼ˆé¿å…å¤ªæ‰“æ“¾ï¼šå»¶é²ä¸€ä¸‹ï¼‰
      setTimeout(() => {
        // è‹¥ä½¿ç”¨è€…æ­£åœ¨é»æ“Šï¼Œå°±ä¸å¼·åˆ¶å½ˆï¼›é€™è£¡æº«æŸ”é»ï¼šåªé¡¯ç¤ºå…¥å£å³å¯
        // ä½ è‹¥æƒ³ã€ŒçœŸçš„è‡ªå‹•å½ˆå‡ºã€ï¼ŒæŠŠä¸‹é¢ä¸€è¡Œå–æ¶ˆè¨»è§£ï¼š
        // openInstallModal();
      }, 700);
    }
  });

  function openInstallModal(){
    document.getElementById('install-modal').style.display = 'flex';
    // è‹¥æ²’æœ‰å¯å®‰è£äº‹ä»¶ï¼Œå°± disable
    const btn = document.getElementById('install-now-btn');
    if(!deferredPrompt){
      btn.setAttribute('disabled','disabled');
      btn.innerText = 'ğŸ“² ä¸€éµå®‰è£ï¼ˆæ­¤ç€è¦½å™¨ä¸æ”¯æ´ï¼‰';
    }else{
      btn.removeAttribute('disabled');
      btn.innerText = 'ğŸ“² ä¸€éµå®‰è£';
    }
  }
  function closeInstallModal(e){
    document.getElementById('install-modal').style.display = 'none';
  }
  function switchTab(type){
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
    if(type === 'apple'){
      document.querySelectorAll('.tab-btn')[0].classList.add('active');
      document.getElementById('apple-pane').classList.add('active');
    }else{
      document.querySelectorAll('.tab-btn')[1].classList.add('active');
      document.getElementById('android-pane').classList.add('active');
    }
  }
  async function doInstall(){
    if(!deferredPrompt){
      alert('æ­¤ç€è¦½å™¨æš«ä¸æ”¯æ´ä¸€éµå®‰è£ï¼Œè«‹ä¾ä¸‹æ–¹æ•™å­¸æ“ä½œã€‚');
      return;
    }
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    alert('è‹¥å·²å®‰è£æˆåŠŸï¼Œè«‹å›åˆ°æ¡Œé¢æŸ¥çœ‹åç‰‡ Appã€‚');
  }

  // ===== Helpers =====
  async function safeCopy(text){
    try{
      if(navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(e){}
    try{
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.setAttribute('readonly','');
      ta.style.position='fixed';
      ta.style.top='-9999px';
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, ta.value.length);
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return ok;
    }catch(e){
      return false;
    }
  }

  async function copyCurrentUrl(){
    const ok = await safeCopy(window.location.href); // âœ…æˆå“å°±æ˜¯æˆå“
    alert(ok ? 'ç¶²å€å·²è¤‡è£½ï¼' : 'æ­¤ç€è¦½å™¨é™åˆ¶è¤‡è£½ï¼Œè«‹é•·æŒ‰ç¶²å€åˆ—è¤‡è£½');
  }

  async function handleShare(){
    // âœ…åŒ copyCurrentUrlï¼šè¤‡è£½ç•¶å‰ç¶²å€ï¼ˆæˆå“/é–€é¢éƒ½æ­£ç¢ºï¼‰
    await copyCurrentUrl();
  }

  function showWechatText(){
    document.getElementById('wechat-mask').style.display = 'flex';
  }
  async function copyWechat(){
    const id = document.getElementById('wechat-id-text').innerText.trim();
    if(!id || id === 'æœªæä¾›'){ alert('æ­¤åç‰‡æœªæä¾›å¾®ä¿¡ ID'); return; }
    const ok = await safeCopy(id);
    alert(ok ? 'å¾®ä¿¡ ID å·²è¤‡è£½ï¼' : 'æ­¤ç€è¦½å™¨é™åˆ¶è¤‡è£½ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
  }

  function setTheme(t){
    curTheme = t;
    localStorage.setItem(LS_THEME, t);
    updateClass();
  }
  function setStyle(s, btn){
    curStyle = s;
    localStorage.setItem(LS_STYLE, s);
    updateClass();
    if(btn){
      document.querySelectorAll('.btn-style').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    }
  }

  function updateClass(){
    document.body.className = `${curTheme} style-${curStyle}${uiMain ? ' mode-main' : ' mode-delivery'}`;
    const meta = document.querySelector('meta[name="theme-color"]');
    if(meta) meta.setAttribute('content', getComputedStyle(document.documentElement).getPropertyValue('--p').trim() || '#ee5253');
  }

  function handleGate(){
    if(!uiMain) return;
    clicks++;
    if(clicks >= 3){
      document.getElementById('work-drawer').style.maxHeight = '420px';
      clicks = 0;
    }
    setTimeout(()=>clicks=0, 1000);
  }

  // ===== Image fixer =====
  function fixImg(url){
    if(!url) return '';
    const idMatch = url.match(/id=([-\w]+)/) || url.match(/d\/([-\w]+)/);
    return idMatch ? `https://drive.google.com/thumbnail?id=${idMatch[1]}&sz=w1000` : url;
  }

  // ===== CSV parse =====
  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = '';
    let i = 0;
    let inQuotes = false;

    while(i < text.length){
      const ch = text[i];

      if(inQuotes){
        if(ch === '"'){
          const next = text[i+1];
          if(next === '"'){ cur += '"'; i += 2; continue; }
          inQuotes = false; i++; continue;
        }
        cur += ch; i++; continue;
      }else{
        if(ch === '"'){ inQuotes = true; i++; continue; }
        if(ch === ','){ row.push(cur.trim()); cur=''; i++; continue; }
        if(ch === '\n' || ch === '\r'){
          if(ch === '\r' && text[i+1] === '\n') i++;
          row.push(cur.trim()); cur='';
          if(row.some(c => c !== '')) rows.push(row);
          row = []; i++; continue;
        }
        cur += ch; i++; continue;
      }
    }
    row.push(cur.trim());
    if(row.some(c => c !== '')) rows.push(row);
    return rows;
  }

  async function loadSheetData(){
    // âœ…ä½ ç›®å‰å›ºå®šçš„ CSV åŒ¯å‡ºï¼ˆæ²¿ç”¨ä½ åŸæœ¬çš„ gidï¼‰
    const csvUrl = "https://docs.google.com/spreadsheets/d/16c21SGmuUVpKVnUrCvWt88OWZdepI76hawWW3DvNJMY/export?format=csv&gid=1350316682&t=" + Date.now();
    const res = await fetch(csvUrl, { cache:'no-store' });
    const text = await res.text();
    allRows = parseCSV(text);
  }

  // ===== Link helpers =====
  const isLineDomain = (v) => {
    const s = (v || '').toLowerCase();
    return (
      s.startsWith('line://') ||
      s.includes('line.me') ||
      s.includes('lin.ee') ||
      s.includes('liff.line.me') ||
      s.includes('linevoom.line.me') ||
      s.includes('openchat.line.me') ||
      s.includes('line.biz') ||
      s.includes('access.line.me') ||
      s.includes('social-plugins.line.me')
    );
  };
  const isMapUrl = (u) => {
    const v = (u || "").toLowerCase();
    return (
      v.includes('google.com/maps') ||
      v.includes('maps.google') ||
      v.includes('maps.app.goo.gl') ||
      v.includes('share.google') ||
      v.includes('goo.gl/maps') ||
      v.includes('maps.apple.com')
    );
  };
  const parseAddressOrUrl = (raw) => {
    const s = (raw || "").trim();
    if(!s) return { type:'none', value:'' };
    const httpIdx = s.indexOf('http');
    if(httpIdx >= 0){
      const maybeAddr = s.slice(0, httpIdx).trim();
      const maybeUrl  = s.slice(httpIdx).trim();
      return { type:'mixed', addr: maybeAddr, url: maybeUrl };
    }
    return { type:'plain', value: s };
  };
  const toNavUrl = (raw) => {
    const p = parseAddressOrUrl(raw);
    if(p.type === 'mixed'){
      if(p.addr) return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(p.addr)}`;
      if(p.url){
        if((p.url || "").toLowerCase().includes('maps.apple.com')) return p.url;
        if(isMapUrl(p.url)) return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(p.url)}`;
        return p.url;
      }
    }
    if(p.type === 'plain' && p.value.includes('http')){
      const url = p.value;
      if(url.toLowerCase().includes('maps.apple.com')) return url;
      if(isMapUrl(url)) return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(url)}`;
      return url;
    }
    if(p.type === 'plain'){
      return `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(p.value)}`;
    }
    return '';
  };
  const isProbablyAddress = (raw) => {
    const s = (raw || "").trim();
    if(!s) return false;
    if(/[å¸‚ç¸£å€é„‰é®é‡Œè·¯è¡—å··å¼„è™Ÿæ¨“]/.test(s)) return true;
    if(/^\d{3}(\d{2})?\s?/.test(s)) return true;
    if(s.includes('http') && isMapUrl(s)) return true;
    if(s.includes('http') && s.indexOf('http') > 0) return true;
    return false;
  };
  const linkIconHtml = (val) => {
    const raw = String(val || "").trim();
    const v = raw.toLowerCase();
    if(isProbablyAddress(raw)) return '<i class="fa-solid fa-map-location-dot"></i>';
    if(v.includes('youtube') || v.includes('youtu.be')) return '<i class="fa-solid fa-play"></i>';
    if(v.includes('tiktok') || v.includes('douyin')) return '<i class="fa-brands fa-tiktok"></i>';
    return '<i class="fa-solid fa-link"></i>';
  };
  const normalizeWebOrAddress = (val) => {
    const raw = String(val || "").trim();
    if(!raw) return "";
    if(isLineDomain(raw)) return "";
    if(raw.toLowerCase().includes('drive.google.com')) return "";
    if(isProbablyAddress(raw)) return toNavUrl(raw);
    const httpIdx = raw.indexOf('http');
    if(httpIdx < 0) return "";
    return raw.slice(httpIdx).trim();
  };

  function fillSocialLinks(list){
    for(let i=1;i<=3;i++){
      const el = document.getElementById('lk'+i);
      el.style.display='none';
      el.href='#';
      el.innerHTML='';
    }
    const cleaned=[];
    (list||[]).forEach(v=>{
      const href = normalizeWebOrAddress(v);
      if(!href) return;
      cleaned.push({ raw:String(v||'').trim(), href });
    });

    let count=1;
    for(const item of cleaned){
      if(count>3) break;
      const el = document.getElementById('lk'+count);
      el.style.display='flex';
      el.innerHTML = linkIconHtml(item.raw);
      el.href = item.href;
      count++;
    }

    // å¦‚æœéƒ½æ²’ç¤¾ç¾¤ï¼Œç¸®å° bar é«˜åº¦
    const any = cleaned.length>0;
    document.getElementById('social-bar').style.minHeight = any ? '46px' : '10px';
  }

  // ===== Render helpers =====
  function getByHeader(h, d, keyLike){
    const idx = h.findIndex(head => (head || "").includes(keyLike));
    return (idx !== -1 && d[idx]) ? d[idx] : "";
  }

  function applyRow(h, d, opt){
    const isMainData = !!(opt && opt.isMainData);
    const keepUiMain = !!(opt && opt.keepUiMain);

    uiMain = keepUiMain ? true : !urlId;
    updateClass();

    const name   = getByHeader(h,d,'å§“å');
    const unit   = getByHeader(h,d,'å–®ä½') || getByHeader(h,d,'å–®ä½åç¨±');
    const motto  = getByHeader(h,d,'ç†å¿µæ¨™èª');
    const service= getByHeader(h,d,'æœå‹™é …ç›®') || getByHeader(h,d,'æœå‹™');

    const avatar = fixImg(getByHeader(h,d,'å€‹äººå°ˆæ¥­å½¢è±¡ç…§') || getByHeader(h,d,'å½¢è±¡ç…§'));
    const logo   = fixImg(getByHeader(h,d,'å“ç‰Œ Logo') || getByHeader(h,d,'å“ç‰ŒLogo') || getByHeader(h,d,'Logo'));

    const wechat = getByHeader(h,d,'å¾®ä¿¡') || getByHeader(h,d,'å¾®ä¿¡ ID');
    const email  = getByHeader(h,d,'ä¸€éµè¯ç¹« Email') || getByHeader(h,d,'Email') || getByHeader(h,d,'éƒµç®±');
    const phone  = getByHeader(h,d,'ä¸€éµè¯ç¹«é›»è©±') || getByHeader(h,d,'é›»è©±');
    const lineP  = getByHeader(h,d,'ç§è¨Š LINE') || getByHeader(h,d,'LINE åŠ å¥½å‹') || getByHeader(h,d,'å€‹äººå¥½å‹');
    const lineOA = getByHeader(h,d,'LINE å®˜æ–¹') || getByHeader(h,d,'å®˜æ–¹å¸³è™Ÿ');

    const v1 = getByHeader(h,d,'å½±éŸ³å¹³å° 1') || getByHeader(h,d,'å½±éŸ³å¹³å°1');
    const v2 = getByHeader(h,d,'å½±éŸ³å¹³å° 2') || getByHeader(h,d,'å½±éŸ³å¹³å°2');
    const v3 = getByHeader(h,d,'å½±éŸ³å¹³å° 3') || getByHeader(h,d,'å½±éŸ³å¹³å°3');
    const s1 = getByHeader(h,d,'ç¤¾ç¾¤å¹³å° 1') || getByHeader(h,d,'ç¤¾ç¾¤å¹³å°1');
    const s2 = getByHeader(h,d,'ç¤¾ç¾¤å¹³å° 2') || getByHeader(h,d,'ç¤¾ç¾¤å¹³å°2');
    const s3 = getByHeader(h,d,'ç¤¾ç¾¤å¹³å° 3') || getByHeader(h,d,'ç¤¾ç¾¤å¹³å°3');

    document.getElementById('u-name').innerText = name || "ï¼ˆæœªå¡«å§“åï¼‰";
    document.getElementById('u-unit').innerText = unit || "ï¼ˆæœªå¡«å–®ä½ï¼‰";
    document.getElementById('u-service').innerText = service || "ï¼ˆæœªå¡«æœå‹™é …ç›®ï¼‰";

    document.getElementById('u-img').src = avatar || "https://drive.google.com/thumbnail?id=18izl3Ym9zRDLtqe6zplRhB7mFjDA3tuB&sz=w1000";

    const mottoEl = document.getElementById('u-motto');
    if(motto){
      mottoEl.style.display='block';
      mottoEl.innerText = motto;
    }else{
      mottoEl.style.display='none';
      mottoEl.innerText='';
    }

    const logoWrap = document.getElementById('brand-logo');
    const logoImg  = document.getElementById('u-logo');
    if(logo){
      logoImg.src = logo;
      logoWrap.style.display='flex';
    }else{
      logoImg.src='';
      logoWrap.style.display='none';
    }

    // social links: å½±éŸ³/å°èˆªå„ªå…ˆï¼Œå†ç¤¾ç¾¤
    fillSocialLinks([v1,v2,v3,s1,s2,s3]);

    // main vs delivery visible
    if(isMainData){
      document.getElementById('advantage-box').style.display='block';
      document.getElementById('order-box').style.display='block';
      document.getElementById('install-entry').classList.add('hidden');
      document.getElementById('wechat-id-text').innerText = "a0973180707";
    }else{
      document.getElementById('advantage-box').style.display='none';
      document.getElementById('order-box').style.display='none';
      document.getElementById('install-entry').classList.remove('hidden');
      document.getElementById('wechat-id-text').innerText = wechat || "æœªæä¾›";
    }

    // contact buttons dynamic balance
    const btnOA = document.getElementById('btn-oa');
    const btnLineP = document.getElementById('btn-linep');
    const btnMail = document.getElementById('btn-mail');
    const btnPhone = document.getElementById('btn-phone');
    const btnWechat = document.getElementById('btn-wechat');

    // LINE OA
    if(lineOA && String(lineOA).includes('http')){
      btnOA.href = lineOA;
      btnOA.classList.remove('hidden');
    }else{
      // ä¸»é ä»é¡¯ç¤ºé è¨­å®˜æ–¹
      if(isMainData){
        btnOA.href = "https://lin.ee/2ac9Roe";
        btnOA.classList.remove('hidden');
      }else{
        btnOA.classList.add('hidden');
      }
    }

    // LINE personal
    if(lineP && String(lineP).includes('http')){
      btnLineP.href = lineP;
      btnLineP.classList.remove('hidden');
    }else{
      btnLineP.classList.add('hidden');
    }

    // mail
    if(email){
      btnMail.href = `mailto:${email}`;
      btnMail.classList.remove('hidden');
      btnMail.querySelector('.btn-subtitle').innerText = email.length > 18 ? 'ä¸€éµå¯„ä¿¡ï¼ˆå·²å¡«ï¼‰' : email;
    }else{
      btnMail.classList.add('hidden');
    }

    // phone
    if(phone){
      btnPhone.href = `tel:${String(phone).replace(/\s+/g,'')}`;
      btnPhone.classList.remove('hidden');
      btnPhone.querySelector('.btn-subtitle').innerText = String(phone);
    }else{
      btnPhone.classList.add('hidden');
    }

    // wechat
    if(wechat){
      btnWechat.classList.remove('hidden');
      btnWechat.querySelector('.btn-subtitle').innerText = 'é»æ“Šé¡¯ç¤º ID';
    }else{
      btnWechat.classList.add('hidden');
    }

    // âœ… å‹•æ…‹å¹³è¡¡ï¼šä¾å¯è¦‹æŒ‰éˆ•æ•¸é‡è‡ªå‹•æ›ç‰ˆ
    balanceActionsGrid();
  }

  function balanceActionsGrid(){
    const wrap = document.getElementById('actions-area');
    const btns = Array.from(wrap.querySelectorAll('.act-btn')).filter(el => !el.classList.contains('hidden'));

    // reset
    wrap.classList.remove('one-col','three');

    // è‹¥åªå‰© 1 æ¬„/2 æ¬„å¤ªæ€ªï¼Œåšæˆ 1æ¬„
    if(btns.length <= 2){
      wrap.classList.add('one-col');
      // è®“ä¸»æŒ‰éˆ•ä¸è¦ span 2
      const main = wrap.querySelector('.btn-main');
      if(main) main.style.gridColumn = 'span 1';
    }else{
      // æ¢å¾© span
      const main = wrap.querySelector('.btn-main');
      if(main) main.style.gridColumn = 'span 2';
    }

    // è‹¥æœ‰ 5 å€‹ä»¥ä¸Šï¼Œæ”¹ä¸‰æ¬„æ›´çœé«˜åº¦
    if(btns.length >= 5){
      wrap.classList.add('three');
      const main = wrap.querySelector('.btn-main');
      if(main) main.style.gridColumn = 'span 3';
    }
  }

  function renderMainFixedFirstRow(){
    if(!allRows[0] || !allRows[1]) return;
    applyRow(allRows[0], allRows[1], { isMainData:true, keepUiMain:true });
  }

  function renderById(keyword, keepUiMain){
    if(!keyword || !allRows[0]) return false;
    const h = allRows[0];
    const d = allRows.find((r, idx) => idx !== 0 && (r[0] == keyword || r[1] == keyword));
    if(!d) return false;
    applyRow(h, d, { isMainData:false, keepUiMain: !!keepUiMain });
    return true;
  }

  function doPreviewInPlace(){
    const id = (document.getElementById('work-id').value || "").trim();
    if(!id){ alert("è«‹å…ˆè¼¸å…¥åºè™Ÿæˆ–å§“å"); return; }
    const ok = renderById(id, true);
    if(!ok){ alert("æ‰¾ä¸åˆ°æ­¤åºè™Ÿ/å§“å"); return; }
    document.querySelector('.info-scroll')?.scrollTo({ top:0, behavior:'smooth' });
  }

  async function doCopy(){
    const id = (document.getElementById('work-id').value || "").trim();
    if(!id){ alert("è«‹å…ˆè¼¸å…¥åºè™Ÿæˆ–å§“å"); return; }
    const finalUrl = `${window.location.origin}${window.location.pathname}?id=${encodeURIComponent(id)}&theme=${encodeURIComponent(curTheme)}&style=${encodeURIComponent(curStyle)}`;
    const ok = await safeCopy(finalUrl);
    alert(ok ? "âœ… äº¤è²¨ç¶²å€å·²è¤‡è£½ï¼ï¼ˆå·²å¸¶é¡è‰²/ç‰ˆå‹ï¼‰" : "æ­¤ç€è¦½å™¨é™åˆ¶è¤‡è£½ï¼Œè«‹æ‰‹å‹•è¤‡è£½ç¶²å€åˆ—");
  }

  async function init(){
    // style/theme apply early
    updateClass();

    try{
      await loadSheetData();
    }catch(e){
      // è‹¥è³‡æ–™çœŸçš„è®€ä¸åˆ°ï¼Œçµ¦ä½¿ç”¨è€…æç¤º
      document.getElementById('u-name').innerText = 'è³‡æ–™è®€å–å¤±æ•—';
      document.getElementById('u-unit').innerText = 'è«‹ç¢ºèªè©¦ç®—è¡¨æ¬Šé™/ç¶²è·¯';
      document.getElementById('u-service').innerText = 'ï¼ˆç„¡æ³•å–å¾—è©¦ç®—è¡¨è³‡æ–™ï¼‰';
      // contact grid still balance
      balanceActionsGrid();
      return;
    }

    if(urlId){
      uiMain = false;
      const ok = renderById(urlId, false);
      if(!ok){
        uiMain = true;
        renderMainFixedFirstRow();
      }
    }else{
      uiMain = true;
      renderMainFixedFirstRow();
    }

    // style button active
    document.querySelectorAll('.btn-style').forEach(b => b.classList.remove('active'));
    const mapBtn = { arch:0, flat:1, spot:2 };
    const idx = mapBtn[curStyle] ?? 0;
    const btns = document.querySelectorAll('.btn-style');
    if(btns[idx]) btns[idx].classList.add('active');

    updateClass();
  }

  init();
</script>
</body>
</html>